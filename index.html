<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutri-Track Anti-Cholest√©rol 8 Sem - Hocine</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 15px; color: #333;}
        .container {max-width: 950px; margin: 0 auto; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        h1 {text-align: center; color: #667eea; margin-bottom: 5px; font-size: 26px;}
        .version-badge {text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin: 5px;}
        .gas-badge {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);}
        .season-badge {background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);}
        .cholesterol-badge {background: linear-gradient(135deg, #fab005 0%, #f59f00 100%);}
        .header-info {text-align: center; color: #666; margin-bottom: 15px; font-size: 13px;}
        .timeline-container {background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; overflow-x: auto;}
        .timeline {display: flex; justify-content: space-between; align-items: center; position: relative; max-width: 100%;}
        .timeline-line {position: absolute; top: 50%; left: 5%; right: 5%; height: 4px; background: #dee2e6; z-index: 0; transform: translateY(-50%);}
        .timeline-progress {position: absolute; top: 50%; left: 5%; height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); z-index: 1; transform: translateY(-50%); transition: width 0.5s;}
        .timeline-item {position: relative; z-index: 2; text-align: center; cursor: pointer; flex: 1; padding: 5px;}
        .timeline-dot {width: 40px; height: 40px; border-radius: 50%; background: white; border: 4px solid #dee2e6; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; transition: all 0.3s;}
        .timeline-item.active .timeline-dot {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; transform: scale(1.2);}
        .timeline-item.completed .timeline-dot {background: #51cf66; border-color: #51cf66; color: white;}
        .timeline-item.future .timeline-dot {background: #f8f9fa; border-color: #dee2e6;}
        .timeline-label {font-size: 11px; font-weight: bold; color: #666;}
        .timeline-phase {font-size: 9px; color: #999; margin-top: 2px;}
        .day-tracker {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center;}
        .day-display {font-size: 28px; font-weight: bold; margin: 10px 0;}
        .day-controls {display: flex; gap: 8px; justify-content: center; margin-top: 10px; flex-wrap: wrap;}
        .auto-save-indicator {position: fixed; top: 20px; right: 20px; background: #51cf66; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        .auto-save-indicator.show {opacity: 1;}
        .tabs {display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; margin-bottom: 20px;}
        .tab {padding: 12px 8px; background: #f0f0f0; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 12px;}
        .tab.active {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);}
        .tab-content {display: none;}
        .tab-content.active {display: block; animation: fadeIn 0.4s;}
        @keyframes fadeIn {from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
        @keyframes slideIn {from {opacity: 0; transform: translateX(100px);} to {opacity: 1; transform: translateX(0);}}
        @keyframes slideOut {from {opacity: 1; transform: translateX(0);} to {opacity: 0; transform: translateX(100px);}}
        .nutrition-section {background: #f0f4ff; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #667eea;}
        .nutrition-section h3 {color: #667eea; margin-bottom: 12px; font-size: 18px;}
        .meal {background: white; padding: 12px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .meal-details {display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; margin: 8px 0; font-size: 12px;}
        .detail-item {background: #f0f0f0; padding: 5px 8px; border-radius: 6px;}
        .detail-label {font-weight: bold; color: #667eea;}
        .meal-foods {background: #f9fafb; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 13px; line-height: 1.6;}
        .meal-foods ul {margin-left: 20px;}
        .season-tag {background: #fff9e6; color: #ff6b00; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 5px;}
        .cholesterol-tag {background: #fff3bf; color: #f59f00; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 5px;}
        .gas-tip {background: #e8f5e9; border-left: 4px solid #51cf66; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .hydration-note {background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .validation-checkbox {display: flex; align-items: center; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer;}
        .validation-checkbox input {width: 20px; height: 20px; cursor: pointer;}
        .validation-checkbox.validated {background: #c8e6c9;}
        .progress-card {background: white; padding: 15px; border-radius: 10px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .progress-bar-container {background: #e0e0e0; border-radius: 10px; height: 30px; margin: 10px 0; overflow: hidden;}
        .progress-bar {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;}
        .macro-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0;}
        .macro-card {background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); padding: 15px; border-radius: 10px; text-align: center;}
        .macro-card.calories {background: linear-gradient(135deg, #ffd93d 0%, #ff9800 100%); color: white;}
        .macro-card.proteines {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
        .macro-card.glucides {background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%); color: white;}
        .macro-card.lipides {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white;}
        .macro-card.hydration {background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white;}
        .macro-value {font-size: 28px; font-weight: bold; margin: 5px 0;}
        .macro-label {font-size: 11px; opacity: 0.9; text-transform: uppercase;}
        .week-card {background: white; border-radius: 15px; padding: 20px; margin: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 6px solid #667eea;}
        .week-card.agressive {border-left-color: #ff6b6b;}
        .week-card.deload {border-left-color: #ffc107;}
        .week-card.moderee {border-left-color: #51cf66;}
        .week-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .week-title {font-size: 22px; font-weight: bold; color: #667eea;}
        .phase-badge {padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white;}
        .phase-badge.agressive {background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);}
        .phase-badge.deload {background: linear-gradient(135deg, #ffc107 0%, #ffd54f 100%);}
        .phase-badge.moderee {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 15px 0;}
        .stat-item {background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;}
        .stat-value {font-size: 24px; font-weight: bold; color: #667eea; margin: 5px 0;}
        .stat-label {font-size: 11px; color: #666; text-transform: uppercase;}
        .chart-container {background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 15px 0; min-height: 300px; position: relative;}
        .chart-svg {width: 100%; height: 250px;}
        .form-group {margin: 15px 0;}
        .form-label {display: block; font-weight: bold; color: #667eea; margin-bottom: 8px; font-size: 14px;}
        .form-input {width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s;}
        .form-input:focus {border-color: #667eea; outline: none;}
        .form-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;}
        .alert-box {padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; border-left: 4px solid;}
        .alert-success {background: #e8f5e9; border-color: #51cf66; color: #2e7d32;}
        .alert-warning {background: #fff9e6; border-color: #ffc107; color: #f57c00;}
        .alert-danger {background: #ffebee; border-color: #ff6b6b; color: #c62828;}
        .alert-info {background: #e3f2fd; border-color: #2196f3; color: #1565c0;}
        .grignotage-section {background: #fff9e6; border-left: 5px solid #ffc107; padding: 15px; border-radius: 15px; margin: 15px 0;}
        .grignotage-item {background: white; padding: 10px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;}
        .btn {padding: 10px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 13px;}
        .btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
        .btn-primary:hover {transform: scale(1.05); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);}
        .btn-secondary {background: rgba(255,255,255,0.2); color: white; border: 2px solid white;}
        .btn-danger {background: #ff6b6b; color: white;}
        .btn-success {background: #51cf66; color: white;}
        .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; overflow-y: auto;}
        .modal.show {display: flex;}
        .modal-content {background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; margin: 20px; animation: modalPop 0.3s; max-height: 90vh; overflow-y: auto;}
        @keyframes modalPop {from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;}}
        .modal-header {font-size: 22px; font-weight: bold; color: #667eea; margin-bottom: 15px; text-align: center;}
        .modal-body {margin: 15px 0;}
        .notes-area {width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 13px; margin-top: 10px;}
        .info-box {background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px;}
        .warning-box {background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px;}
        @media (max-width: 600px) {.container {padding: 12px;} h1 {font-size: 22px;} .macro-grid, .stats-grid {grid-template-columns: repeat(2, 1fr);} .timeline-item {padding: 2px;} .timeline-dot {width: 30px; height: 30px; font-size: 10px;} .timeline-label, .timeline-phase {font-size: 9px;}}
    </style>
</head>
<body>
    <div class="auto-save-indicator" id="auto-save-indicator">‚úÖ Sauvegard√©</div>
    <div class="container">
        <h1>üî• PLAN ANTI-CHOLEST√âROL 8 SEMAINES</h1>
        <div style="text-align: center;">
            <span class="version-badge">v4.0 ANTI-CHOLEST√âROL ‚Ä¢ Hocine 44 ans</span>
            <span class="version-badge season-badge" id="season-badge">üçÇ AUTOMNE</span>
            <span class="version-badge gas-badge">üåø ANTI-GAZ</span>
            <span class="version-badge cholesterol-badge">üíä ANTI-CHOLEST√âROL</span>
        </div>
        <div class="header-info">93.4kg ‚Ä¢ 105cm taille ‚Ä¢ Objectif 88kg en 8 semaines ‚Ä¢ Cholest√©rol: 2.37g/L ‚Üí &lt;2g/L</div>
        
        <div class="timeline-container">
            <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #667eea;">PROGRESSION 8 SEMAINES</div>
            <div class="timeline">
                <div class="timeline-line"></div>
                <div class="timeline-progress" id="timeline-progress" style="width: 0%"></div>
                <div class="timeline-item" onclick="afficherSemaine(1)">
                    <div class="timeline-dot">S1</div>
                    <div class="timeline-label">Semaine 1</div>
                    <div class="timeline-phase">Agressive</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(2)">
                    <div class="timeline-dot">S2</div>
                    <div class="timeline-label">Semaine 2</div>
                    <div class="timeline-phase">Agressive</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(3)">
                    <div class="timeline-dot">S3</div>
                    <div class="timeline-label">Semaine 3</div>
                    <div class="timeline-phase">Agressive</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(4)">
                    <div class="timeline-dot">S4</div>
                    <div class="timeline-label">Semaine 4</div>
                    <div class="timeline-phase">Agressive</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(5)">
                    <div class="timeline-dot">S5</div>
                    <div class="timeline-label">Semaine 5</div>
                    <div class="timeline-phase">Deload</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(6)">
                    <div class="timeline-dot">S6</div>
                    <div class="timeline-label">Semaine 6</div>
                    <div class="timeline-phase">Mod√©r√©e</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(7)">
                    <div class="timeline-dot">S7</div>
                    <div class="timeline-label">Semaine 7</div>
                    <div class="timeline-phase">Mod√©r√©e</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(8)">
                    <div class="timeline-dot">S8</div>
                    <div class="timeline-label">Semaine 8</div>
                    <div class="timeline-phase">Mod√©r√©e</div>
                </div>
            </div>
        </div>

        <div class="day-tracker">
            <div style="font-size: 14px; margin-bottom: 5px;">üìÖ <span id="semaine-actuelle-label">SEMAINE 1</span></div>
            <div class="day-display" id="day-display">üèãÔ∏è JOUR TRAINING</div>
            <div class="day-controls">
                <button class="btn btn-secondary" onclick="setDayType('training')">üèãÔ∏è Training</button>
                <button class="btn btn-secondary" onclick="setDayType('repos')">üí§ Repos</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('menu')">üìã MENU</button>
            <button class="tab" onclick="showTab('suivi8sem')">üìä SUIVI</button>
            <button class="tab" onclick="showTab('saison')">üçÇ SAISON</button>
            <button class="tab" onclick="showTab('antigaz')">üåø ANTI-GAZ</button>
            <button class="tab" onclick="showTab('cholesterol')">üíä CHOLEST√âROL</button>
            <button class="tab" onclick="showTab('grignotages')">üç™ SNACKS</button>
            <button class="tab" onclick="showTab('export')">üì§ EXPORT</button>
        </div>

        <div id="tab-menu" class="tab-content active">
            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìä Progression du jour</h3>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar" style="width: 0%">0%</div></div>
                <div class="macro-grid">
                    <div class="macro-card calories"><div class="macro-label">Calories</div><div class="macro-value"><span id="cal-actuel">0</span>/<span id="cal-total">2420</span></div></div>
                    <div class="macro-card proteines"><div class="macro-label">Prot√©ines</div><div class="macro-value"><span id="prot-actuel">0</span>/<span id="prot-total">239</span>g</div></div>
                    <div class="macro-card glucides"><div class="macro-label">Glucides</div><div class="macro-value"><span id="gluc-actuel">0</span>/<span id="gluc-total">252</span>g</div></div>
                    <div class="macro-card lipides"><div class="macro-label">Lipides</div><div class="macro-value"><span id="lip-actuel">0</span>/<span id="lip-total">74</span>g</div></div>
                    <div class="macro-card hydration"><div class="macro-label">Hydratation</div><div class="macro-value"><span id="hydra-actuel">0</span>/<span id="hydra-total">4.1</span>L</div></div>
                </div>
            </div>
            <div id="menu-container"></div>
            <textarea class="notes-area" id="notes-jour" placeholder="üìù Notes du jour (√©nergie, sensations, gaz, digestion, cholest√©rol...)" oninput="showAutoSave()"></textarea>
        </div>

        <div id="tab-suivi8sem" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üìä Suivi Plan Anti-Cholest√©rol 8 Semaines</h2>
            
            <div id="carte-semaine-actuelle"></div>
            
            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìà √âvolution Poids & Mensurations</h3>
                <div class="chart-container" id="chart-poids">
                    <svg class="chart-svg" id="svg-poids"></svg>
                </div>
            </div>

            <div id="alertes-container"></div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Historique Pes√©es</h3>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="ouvrirFormulairePesee()">‚öñÔ∏è Nouvelle pes√©e (Vendredi/Samedi)</button>
                <div id="historique-pesees"></div>
            </div>
        </div>

        <div id="tab-saison" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üçÇ Fruits & L√©gumes de Saison</h2>
            <div class="info-box"><strong>üìÖ Saison actuelle :</strong> <span id="season-name-detail">Automne</span> (mise √† jour automatique)</div>
            <div class="progress-card"><h3>üçé Fruits disponibles</h3><div id="fruits-saison" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div></div>
            <div class="progress-card"><h3>ü•¶ L√©gumes anti-gaz disponibles</h3><div id="legumes-saison" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div></div>
        </div>

        <div id="tab-antigaz" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üåø Protocole Anti-Gaz</h2>
            <div class="warning-box"><strong>‚ö†Ô∏è OBJECTIF</strong> : R√©duction gaz 70-80% gr√¢ce aux aliments et √©pices s√©lectionn√©s</div>
            <div class="progress-card">
                <h3>‚úÖ Aliments digestes (0 gaz)</h3>
                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                    <li><strong>Courge butternut / Potimarron</strong> : Champions digestion</li>
                    <li><strong>Carottes cuites 20 min+</strong> : Fibres douces</li>
                    <li><strong>Courgettes vapeur</strong> : Ultra-digeste</li>
                    <li><strong>Fenouil cuit</strong> : Anti-ballonnements naturel</li>
                    <li><strong>Haricots verts bien cuits</strong> : OK si 20 min vapeur</li>
                    <li><strong>√âpinards cuits</strong> : Digestion facile</li>
                    <li><strong>Patate douce</strong> : IG bas + digeste</li>
                </ul>
            </div>
            <div class="progress-card">
                <h3>üåø √âpices carminatives (OBLIGATOIRES)</h3>
                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                    <li><strong>Fenouil</strong> (graines ou bulbe) : Champion anti-gaz</li>
                    <li><strong>Cumin</strong> : Carminatif puissant</li>
                    <li><strong>Coriandre</strong> : Aide digestion</li>
                    <li><strong>Gingembre frais</strong> : Anti-ballonnements</li>
                    <li><strong>Cannelle</strong> : R√©gule glyc√©mie + digestion</li>
                </ul>
            </div>
            <div class="progress-card">
                <h3>‚ùå Aliments retir√©s (gazog√®nes)</h3>
                <ul style="margin: 10px 0 10px 20px; line-height: 1.8; color: #d32f2f;">
                    <li>Brocoli, chou-fleur, choux (tous)</li>
                    <li>Champignons (fermentation)</li>
                    <li>Oignons/ail crus (cuits OK petite quantit√©)</li>
                    <li>Poireaux (partie verte)</li>
                </ul>
            </div>
        </div>

        <div id="tab-cholesterol" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üíä Protocole Anti-Cholest√©rol</h2>
            
            <div class="alert-box alert-info">
                <strong>üéØ OBJECTIF</strong><br>
                Cholest√©rol total : 2.37g/L ‚Üí &lt;2g/L (-15%)<br>
                LDL : 1.62g/L ‚Üí &lt;1.16g/L (-28%)<br>
                HDL : 0.52g/L ‚Üí &gt;0.6g/L (+15%)<br>
                Triglyc√©rides : 1.16g/L ‚Üí &lt;1g/L (-14%)
            </div>

            <div class="progress-card">
                <h3>ü•ó Aliments Cl√©s Anti-Cholest√©rol</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>üåæ Quinoa flocons</strong><br>
                        <small>Beta-glucane ‚Üí -8% cholest√©rol</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>ü•ú Noix</strong><br>
                        <small>Om√©ga-3 ‚Üí -5% LDL</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>üçé Pomme</strong><br>
                        <small>Pectine ‚Üí baisse LDL</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>üç´ Chocolat 90%</strong><br>
                        <small>Polyph√©nols ‚Üí +12% HDL</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>üêü Saumon</strong><br>
                        <small>Om√©ga-3 ‚Üí -20% triglyc√©rides</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>ü•ë Avocat</strong><br>
                        <small>Graisses mono ‚Üí baisse LDL</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>ü•¶ Brocoli</strong><br>
                        <small>Sulforaphane ‚Üí d√©tox cholest√©rol</small>
                    </div>
                    <div style="background: #fff9e6; padding: 12px; border-radius: 8px;">
                        <strong>ü´ê Fruits rouges</strong><br>
                        <small>Anthocyanes ‚Üí -8% LDL</small>
                    </div>
                </div>
            </div>

            <div class="progress-card">
                <h3>üíä Suppl√©ments Anti-Cholest√©rol</h3>
                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                    <li><strong>Om√©ga-3 (3 g√©lules/jour)</strong> : -25% triglyc√©rides</li>
                    <li><strong>Berb√©rine 500mg x2/jour</strong> : -18% cholest√©rol total, -25% LDL</li>
                    <li><strong>Psyllium blond 3g/soir</strong> : -18% LDL (fibres solubles)</li>
                    <li><strong>Vitamine D3 10000 UI</strong> : optimise m√©tabolisme lipidique</li>
                    <li><strong>Curcumine 1000mg</strong> : anti-inflammatoire cardiovasculaire</li>
                </ul>
            </div>

            <div class="progress-card">
                <h3>üö∂ Marche Obligatoire</h3>
                <div class="info-box">
                    <strong>Apr√®s chaque repas : 15-20 min</strong><br>
                    Effet : +5-10% HDL (bon cholest√©rol)<br>
                    Objectif : 10 000 pas/jour minimum
                </div>
            </div>

            <div class="progress-card">
                <h3>üìä Contr√¥les Sanguins</h3>
                <ul style="margin: 10px 0 10px 20px; line-height: 1.8;">
                    <li><strong>Avant programme</strong> : ‚úÖ Fait (11/12/2024)</li>
                    <li><strong>Semaine 4</strong> : Contr√¥le interm√©diaire</li>
                    <li><strong>Semaine 8</strong> : Bilan final complet</li>
                </ul>
            </div>
        </div>

        <div id="tab-grignotages" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üç™ Grignotages</h2>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="openGrignotageModal()">+ Ajouter grignotage</button>
            <div class="grignotage-section" id="liste-grignotages"><p style="color: #999; text-align: center;">Aucun grignotage aujourd'hui üëç</p></div>
            <div class="progress-card"><h3>Total grignotages : <span id="total-grignotages" style="color: #ffc107;">+0 kcal</span></h3></div>
        </div>

        <div id="tab-export" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">üì§ Export & Sauvegarde</h2>
            
            <div class="alert-box alert-info" style="margin-bottom: 20px;">
                <strong>üíæ SAUVEGARDE TES DONN√âES !</strong><br>
                Les donn√©es sont stock√©es uniquement dans ton navigateur.<br>
                Fais un backup r√©gulier pour ne rien perdre !
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">üíæ Sauvegarde compl√®te</h3>
                <button class="btn btn-success" style="width: 100%; margin: 10px 0;" onclick="telechargerBackup()">üíæ T√©l√©charger backup (.json)</button>
                <button class="btn btn-primary" style="width: 100%; margin: 10px 0;" onclick="document.getElementById('input-restore').click()">üì• Restaurer backup</button>
                <input type="file" id="input-restore" accept=".json" style="display: none;" onchange="restaurerBackup(event)">
                <div style="font-size: 12px; color: #999; margin-top: 10px; text-align: center;">
                    Dernier backup : <span id="last-backup-date">Jamais</span>
                </div>
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">üìã Rapports texte</h3>
                <button class="btn btn-primary" style="width: 100%; margin: 10px 0;" onclick="exportRapport()">üìã Copier rapport du jour</button>
                <button class="btn btn-secondary" style="width: 100%; margin: 10px 0;" onclick="exportRapportSemaine()">üìä Copier rapport semaine</button>
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">‚öôÔ∏è Gestion</h3>
                <button class="btn btn-danger" style="width: 100%; margin: 10px 0;" onclick="resetJour()">üîÑ Reset jour actuel</button>
                <button class="btn btn-danger" style="width: 100%; margin: 10px 0;" onclick="resetSemaine()">‚ö†Ô∏è Reset semaine actuelle</button>
                <button class="btn btn-danger" style="width: 100%;" onclick="resetTout()">üóëÔ∏è Effacer toutes les donn√©es</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-pesee">
        <div class="modal-content">
            <div class="modal-header">‚öñÔ∏è Nouvelle Pes√©e Hebdomadaire</div>
            <div class="modal-body">
                <div class="info-box" style="margin-bottom: 15px;">
                    <strong>üìÖ Pes√©e id√©ale :</strong> Vendredi ou Samedi matin, √† jeun, apr√®s toilettes
                </div>
                <div class="form-group">
                    <label class="form-label">Semaine concern√©e</label>
                    <select class="form-input" id="input-semaine">
                        <option value="S1">S1 - Agressive</option>
                        <option value="S2">S2 - Agressive</option>
                        <option value="S3">S3 - Agressive</option>
                        <option value="S4">S4 - Agressive</option>
                        <option value="S5">S5 - Deload</option>
                        <option value="S6">S6 - Mod√©r√©e</option>
                        <option value="S7">S7 - Mod√©r√©e</option>
                        <option value="S8">S8 - Mod√©r√©e</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‚öñÔ∏è Poids (kg) *</label>
                        <input type="number" step="0.1" class="form-input" id="input-poids" placeholder="Ex: 92.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìä % Graisse *</label>
                        <input type="number" step="0.1" class="form-input" id="input-bf" placeholder="Ex: 23.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">üìè Tour taille (cm)</label>
                        <input type="number" step="0.5" class="form-input" id="input-taille" placeholder="Ex: 103">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí™ Tour bras (cm)</label>
                        <input type="number" step="0.5" class="form-input" id="input-bras" placeholder="Ex: 38">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‚ö° √ânergie (/10)</label>
                        <input type="number" min="1" max="10" class="form-input" id="input-energie" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üåø Digestion (/10)</label>
                        <input type="number" min="1" max="10" class="form-input" id="input-digestion" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üí® Gaz (/10)</label>
                        <input type="number" min="1" max="10" class="form-input" id="input-gaz" placeholder="3">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">üìù Notes</label>
                    <textarea class="notes-area" id="input-notes-pesee" placeholder="Sensations, √©nergie training, points √† am√©liorer..." style="min-height: 60px;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('modal-pesee')">Annuler</button>
                <button class="btn btn-success" style="flex: 1;" onclick="enregistrerPesee()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-grignotage">
        <div class="modal-content">
            <div class="modal-header">üç™ Ajouter grignotage</div>
            <div class="modal-body">
                <input type="text" class="form-input" id="input-aliment" placeholder="Aliment (ex: Chocolat noir)">
                <input type="number" class="form-input" id="input-quantite" placeholder="Quantit√© (g)">
                <input type="number" class="form-input" id="input-calories" placeholder="Calories">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('modal-grignotage')">Annuler</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="ajouterGrignotage()">Ajouter</button>
            </div>
        </div>
    </div>

    <script>
const SAISONS={automne:{mois:[9,10,11],nom:'Automne',emoji:'üçÇ',fruits:['Pomme','Poire','Raisin'],legumes:['Courge butternut','Potimarron','Carottes','Courgettes','Fenouil','Haricots verts','√âpinards','Betterave']},hiver:{mois:[12,1,2],nom:'Hiver',emoji:'‚ùÑÔ∏è',fruits:['Pomme','Poire','Orange','Cl√©mentine','Kiwi'],legumes:['Carottes','Courge','√âpinards','Fenouil','Panais','C√©leri','M√¢che']},printemps:{mois:[3,4,5],nom:'Printemps',emoji:'üå∏',fruits:['Fraise','Cerise','Pomme'],legumes:['Carottes nouvelles','Haricots verts','√âpinards','Asperges','Radis','Laitue']},ete:{mois:[6,7,8],nom:'√ât√©',emoji:'‚òÄÔ∏è',fruits:['P√™che','Abricot','Melon','Past√®que'],legumes:['Courgettes','Haricots verts','Carottes','Concombre','Fenouil','Tomate']}};

const PLAN_HYBRIDE = {
    dateDebut: new Date().toISOString().split('T')[0],
    poidsInitial: 93.4,
    tailleInitiale: 105,
    semaines: {
        S1: {phase:'agressive',nom:'S√®che S1',objectif:'Kickstart S√®che + Anti-Cholest√©rol',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S2: {phase:'agressive',nom:'S√®che S2',objectif:'Acc√©l√©ration perte gras',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S3: {phase:'agressive',nom:'S√®che S3',objectif:'Momentum',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S4: {phase:'agressive',nom:'S√®che S4',objectif:'Finalisation phase 1 + Analyses',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S5: {phase:'deload',nom:'Deload & Contr√¥le',objectif:'R√©cup√©ration + analyses',calories:{training:2450,repos:2150},macros:{training:{P:230,G:250,L:70},repos:{P:215,G:165,L:90}},deficitCible:400,perteVisee:0.4,couleur:'#ffc107'},
        S6: {phase:'agressive',nom:'S√®che S6',objectif:'Reprise intensit√©',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S7: {phase:'agressive',nom:'S√®che S7',objectif:'Finalisation',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'},
        S8: {phase:'agressive',nom:'S√®che S8',objectif:'Bilan final + Pr√©paration prise muscle',calories:{training:2350,repos:1950},macros:{training:{P:240,G:230,L:65},repos:{P:220,G:130,L:85}},deficitCible:680,perteVisee:0.8,couleur:'#ff6b6b'}
    }
};

function getSaison(){const mois=new Date().getMonth()+1;for(const[key,saison]of Object.entries(SAISONS)){if(saison.mois.includes(mois))return saison}return SAISONS.automne}
let SAISON_ACTUELLE=getSaison();

const MENUS_BASE={
    training:{
        repas:[
            {
                id:'reveil',
                nom:'Au r√©veil',
                heure:'06:30',
                type:'hydratation',
                aliments:['500ml eau ti√®de + jus 1/2 citron'],
                hydration:0.5,
                gastip:'üåø Hydratation matinale = activation m√©tabolisme + d√©tox'
            },
            {
                id:'petit_dej',
                nom:'Petit-d√©jeuner',
                heure:'08:30',
                calories:580,
                macros:{P:52,G:60,L:16},
                hydration:0.3,
                aliments:[
                    'Flocons avoine 40g <span class="cholesterol-tag">‚≠ê BETA-GLUCANE = -7% CHOLEST√âROL</span>',
                    'Quinoa flocons 25g <span class="cholesterol-tag">‚≠ê ANTI-CHOLEST√âROL</span>',
                    'Lait avoine 200ml',
                    'Whey isolat 45g',
                    '≈íufs 2 entiers + 4 blancs',
                    'Pomme cuite 1 <span class="cholesterol-tag">‚≠ê PECTINE = BAISSE LDL</span>',
                    'Noix 10g <span class="cholesterol-tag">‚≠ê OM√âGA-3 = -5% LDL</span>',
                    'Cannelle 1 c. caf√© <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>'
                ],
                supplements:[
                    'Vitamine D3 : 10000 UI',
                    'Vitamine C : 1000mg',
                    'Om√©ga-3 : 4 g√©lules <span class="cholesterol-tag">‚≠ê -25% TRIGLYC√âRIDES</span>',
                    'Zinc : 15mg',
                    'Curcumine : 1000mg',
                    'Cr√©atine : 5g (dose unique)',
                    'Berb√©rine : 500mg <span class="cholesterol-tag">‚≠ê DOSE 1/3 = -25% LDL</span>'
                ],
                gastip:'üåø Pomme cuite = meilleure digestion que crue',
                cholesteroltip:'üíä Avoine + Noix + Berb√©rine = Combo anti-cholest√©rol matinal puissant'
            },
            {
                id:'collation_matin',
                nom:'Collation',
                heure:'10:30',
                calories:180,
                macros:{P:12,G:24,L:8},
                hydration:0.4,
                aliments:[
                    'Galettes riz complet 3',
                    'Beurre cacahu√®te 12g',
                    'Pomme 1 <span class="cholesterol-tag">‚≠ê PECTINE = CAPTURE CHOLEST√âROL</span>',
                    'Infusion fenouil + Th√© vert'
                ],
                gastip:'üåø Infusion fenouil = anti-ballonnements',
                cholesteroltip:'üíä 2√®me pomme = dose pectine efficace'
            },
            {
                id:'hydra_11h30',
                nom:'Hydratation',
                heure:'11:30',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation avant repas = meilleure digestion'
            },
            {
                id:'pre_training',
                nom:'Pr√©-Training',
                heure:'12:00',
                calories:220,
                macros:{P:24,G:50,L:3},
                hydration:0.2,
                aliments:[
                    'Riz basmati 50g cuit (17g sec)',
                    'Whey isolat 20g',
                    'Banane 1/2',
                    'Cannelle 1 c. caf√© <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>',
                    'Berb√©rine 500mg <span class="cholesterol-tag">‚≠ê DOSE 2/3 avant glucides</span>'
                ],
                note:'‚ö†Ô∏è 90 min avant training',
                gastip:'üåø Riz basmati = IG moyen, digestion rapide',
                cholesteroltip:'üíä Berb√©rine avant glucides = contr√¥le glyc√©mie optimal'
            },
            {
                id:'training',
                nom:'Training',
                heure:'13:30-14:45',
                type:'activite',
                duree:'75 min',
                hydration:0.7,
                aliments:['600-700ml eau + √©lectrolytes'],
                note:'OBLIGATOIRE',
                gastip:'üåø Hydratation pendant effort = performance + r√©cup√©ration'
            },
            {
                id:'post_training',
                nom:'Post-Training',
                heure:'14:50',
                calories:300,
                macros:{P:50,G:55,L:1},
                hydration:0.3,
                aliments:[
                    'Whey isolat 50g',
                    'Riz basmati 70g cuit (23g sec)',
                    'Dattes Medjool 2 (au lieu miel = IG moyen + fibres)',
                    'Cannelle 1 c. caf√© <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>'
                ],
                note:'IMM√âDIAT dans vestiaire',
                gastip:'üåø Dattes = moins de pic glyc√©mique que miel',
                cholesteroltip:'üíä Fen√™tre anabolique post-training optimis√©e'
            },
            {
                id:'hydra_16h',
                nom:'Hydratation',
                heure:'16:00',
                type:'hydratation',
                hydration:0.4,
                aliments:['400ml eau'],
                gastip:'üåø R√©cup√©ration post-training'
            },
            {
                id:'repas_16h30',
                nom:'Repas post-training',
                heure:'16:30',
                calories:520,
                macros:{P:48,G:45,L:18},
                hydration:0.2,
                aliments:[
                    'Poulet/Dinde 200g <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üì¶ BATCH COOKING</span>',
                    'Patate douce 100g <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üì¶ BATCH COOKING</span>',
                    'L√©gumes cuits 300g <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üì¶ BATCH</span> <span class="cholesterol-tag">‚≠ê FIBRES</span>',
                    '‚Ä¢ Mix anti-cholest√©rol : Brocoli 120g + √âpinards 100g + Carottes 80g',
                    '‚Ä¢ OU Mix anti-gaz : Courge 120g + Courgettes 100g + Haricots verts 80g',
                    'Lentilles corail 100g cuites <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;">üì¶ BATCH</span> <span class="cholesterol-tag">‚≠ê -11% LDL</span>',
                    'Huile olive 10ml <span class="cholesterol-tag">‚≠ê ACIDE OL√âIQUE</span>',
                    'Vinaigre cidre 1 c. soupe <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE -34%</span>',
                    'Cumin + coriandre + gingembre',
                    'Berb√©rine 500mg <span class="cholesterol-tag">‚≠ê DOSE 3/3</span>'
                ],
                note:'üì¶ Pr√©par√© dimanche - R√©chauffer 2-3 min micro-ondes',
                gastip:'üåø Lentilles corail = ultra-digeste (15 min cuisson)',
                cholesteroltip:'üíä Lentilles = fibres solubles champion anti-LDL (-11%)'
            },
            {
                id:'hydra_18h30',
                nom:'Hydratation',
                heure:'18:30',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation d√Æner'
            },
            {
                id:'diner',
                nom:'D√Æner',
                heure:'19:15',
                calories:620,
                macros:{P:50,G:35,L:24},
                hydration:0.4,
                aliments:[
                    'Saumon 220g <span class="cholesterol-tag">‚≠ê OM√âGA-3 = -20% TRIGLYC√âRIDES</span>',
                    'L√©gumes cuits 450g <span class="cholesterol-tag">‚≠ê FIBRES MASSIF = -10% LDL</span>',
                    '‚Ä¢ Brocoli 180g <span class="cholesterol-tag">‚≠ê SULFORAPHANE = D√âTOX CHOLEST√âROL</span>',
                    '‚Ä¢ √âpinards 150g',
                    '‚Ä¢ Carottes/Courgettes 120g',
                    'Avocat 1/2 <span class="cholesterol-tag">‚≠ê GRAISSES MONO = BAISSE LDL + MONTE HDL</span>',
                    'Huile olive 15ml <span class="cholesterol-tag">‚≠ê ACIDE OL√âIQUE = -15% LDL</span>',
                    'Vinaigre cidre 1 c. soupe <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>',
                    'Cumin + coriandre + gingembre'
                ],
                note:'üî™ Cuisson vapeur 20 min minimum',
                gastip:'üåø Cuisson 20 min = l√©gumes ultra-digestes, 0 gaz',
                cholesteroltip:'üíä Saumon + L√©gumes massifs + Avocat = Trio gagnant cardiovasculaire'
            },
            {
                id:'marche',
                nom:'Marche digestive',
                heure:'19:45',
                type:'activite',
                duree:'20 min',
                hydration:0.2,
                aliments:['200ml eau'],
                note:'‚ö†Ô∏è OBLIGATOIRE - NON N√âGOCIABLE',
                gastip:'üåø Marche = √©vacue gaz 50% + am√©liore digestion',
                cholesteroltip:'üíä Marche post-d√Æner = +5-10% HDL (bon cholest√©rol) prouv√©'
            },
            {
                id:'hydra_21h30',
                nom:'Hydratation',
                heure:'21:30',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation coucher'
            },
            {
                id:'avant_coucher',
                nom:'Avant coucher',
                heure:'22:00',
                calories:330,
                macros:{P:28,G:18,L:12},
                hydration:0.7,
                aliments:[
                    'Skyr 0% 250g',
                    'Fruits rouges 80g <span class="cholesterol-tag">‚≠ê ANTHOCYANES = -8% LDL</span>',
                    'Cannelle 1/2 c. caf√© <span class="cholesterol-tag">‚≠ê INSULINE +29%</span>',
                    'Graines chia 15g <span class="cholesterol-tag">‚≠ê OM√âGA-3 + FIBRES</span>',
                    'Psyllium blond 5g <span class="cholesterol-tag">‚≠ê FIBRES SOLUBLES = -18% LDL</span>',
                    '200ml eau ti√®de + 500ml apr√®s psyllium (attendre 30 min)',
                    'Tisane fenouil-gingembre'
                ],
                supplements:[
                    'Magn√©sium 500mg (sommeil + constipation)',
                    'Berb√©rine 500mg <span class="cholesterol-tag">‚≠ê Dose nocturne optimale</span>'
                ],
                note:'‚ö†Ô∏è Psyllium = attendre 30 min puis boire 500ml eau',
                gastip:'üåø Routine soir = cl√© digestion + transit optimal',
                cholesteroltip:'üíä Psyllium 5g + Berb√©rine = combo ultra-puissant avant sommeil'
            }
        ],
        hydrationTotal:4.5
    },
    repos:{
        repas:[
            {
                id:'reveil',
                nom:'Au r√©veil',
                heure:'06:30',
                type:'hydratation',
                aliments:['500ml eau ti√®de + citron'],
                hydration:0.5,
                gastip:'üåø Hydratation matinale = d√©tox'
            },
            {
                id:'petit_dej',
                nom:'Petit-d√©jeuner',
                heure:'08:30',
                calories:580,
                macros:{P:52,G:55,L:18},
                hydration:0.3,
                aliments:[
                    'Flocons avoine 40g <span class="cholesterol-tag">‚≠ê BETA-GLUCANE</span>',
                    'Quinoa flocons 20g <span class="cholesterol-tag">‚≠ê ANTI-CHOLEST√âROL</span>',
                    'Lait avoine 200ml',
                    'Whey isolat 45g',
                    '≈íufs 2 entiers + 4 blancs',
                    'Fruits rouges 120g <span class="cholesterol-tag">‚≠ê ANTHOCYANES = -8% LDL</span>',
                    'Noix 12g <span class="cholesterol-tag">‚≠ê OM√âGA-3</span>',
                    'Cannelle 1 c. caf√© <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>'
                ],
                supplements:[
                    'Vitamine D3 : 10000 UI',
                    'Vitamine C : 1000mg',
                    'Om√©ga-3 : 4 g√©lules <span class="cholesterol-tag">‚≠ê -25% TRIGLYC√âRIDES</span>',
                    'Zinc : 15mg',
                    'Curcumine : 1000mg',
                    'Cr√©atine : 5g',
                    'Berb√©rine : 500mg <span class="cholesterol-tag">‚≠ê DOSE 1/3</span>'
                ],
                gastip:'üåø Protocole identique training',
                cholesteroltip:'üíä Morning routine anti-cholest√©rol'
            },
            {
                id:'collation_matin',
                nom:'Collation',
                heure:'10:30',
                calories:170,
                macros:{P:12,G:22,L:8},
                hydration:0.4,
                aliments:[
                    'Galettes riz complet 3',
                    'Beurre cacahu√®te 10g',
                    'Kiwi 2',
                    'Infusion fenouil + Th√© vert'
                ],
                gastip:'üåø Infusion fenouil syst√©matique',
                cholesteroltip:'üíä Kiwi = vitamine C + fibres'
            },
            {
                id:'hydra_11h30',
                nom:'Hydratation',
                heure:'11:30',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation d√©jeuner'
            },
            {
                id:'dejeuner',
                nom:'D√©jeuner',
                heure:'13:00',
                calories:640,
                macros:{P:58,G:40,L:24},
                hydration:0.4,
                aliments:[
                    'Poulet/Dinde 240g',
                    'L√©gumes cuits 400g <span class="cholesterol-tag">‚≠ê FIBRES MASSIF</span>',
                    '‚Ä¢ Courge butternut 160g (digeste)',
                    '‚Ä¢ Courgettes 120g',
                    '‚Ä¢ Haricots verts 120g',
                    'Lentilles corail 150g cuites <span class="cholesterol-tag">‚≠ê FIBRES SOLUBLES = -11% LDL</span>',
                    'Huile olive 15ml <span class="cholesterol-tag">‚≠ê BAISSE LDL</span>',
                    'Vinaigre cidre 1 c. soupe <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>',
                    'Berb√©rine 500mg <span class="cholesterol-tag">‚≠ê DOSE 2/3</span>',
                    'Cumin + coriandre + gingembre'
                ],
                note:'üî™ Cuisson vapeur 20 min',
                gastip:'üåø Lentilles bien cuites = ultra-digeste',
                cholesteroltip:'üíä D√©jeuner massif en l√©gumes = effet max cholest√©rol'
            },
            {
                id:'hydra_15h',
                nom:'Hydratation',
                heure:'15:00',
                type:'hydratation',
                hydration:0.4,
                aliments:['400ml eau'],
                gastip:'üåø Hydratation apr√®s-midi'
            },
            {
                id:'collation_aprem',
                nom:'Collation',
                heure:'16:00',
                calories:210,
                macros:{P:22,G:16,L:9},
                hydration:0.2,
                aliments:[
                    'Skyr 0% 200g',
                    'Pomme 1 <span class="cholesterol-tag">‚≠ê PECTINE</span>',
                    'Noix 10g <span class="cholesterol-tag">‚≠ê OM√âGA-3</span>',
                    'Th√© vert'
                ],
                gastip:'üåø Collation simple et digeste',
                cholesteroltip:'üíä Pomme quotidienne = pectine anti-LDL'
            },
            {
                id:'hydra_18h',
                nom:'Hydratation',
                heure:'18:00',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation d√Æner'
            },
            {
                id:'diner',
                nom:'D√Æner',
                heure:'19:30',
                calories:680,
                macros:{P:58,G:36,L:28},
                hydration:0.4,
                aliments:[
                    'Saumon 240g <span class="cholesterol-tag">‚≠ê OM√âGA-3 = -20% TRIGLYC√âRIDES</span>',
                    'L√©gumes cuits 500g <span class="cholesterol-tag">‚≠ê FIBRES ULTRA-MASSIF</span>',
                    '‚Ä¢ Brocoli 200g <span class="cholesterol-tag">‚≠ê SULFORAPHANE</span>',
                    '‚Ä¢ √âpinards 150g',
                    '‚Ä¢ Carottes 150g <span class="cholesterol-tag">‚≠ê FIBRES SOLUBLES</span>',
                    'Avocat 1/2 <span class="cholesterol-tag">‚≠ê GRAISSES MONO</span>',
                    'Huile olive 15ml <span class="cholesterol-tag">‚≠ê ACIDE OL√âIQUE</span>',
                    'Vinaigre cidre 1 c. soupe <span class="cholesterol-tag">‚≠ê BAISSE GLYC√âMIE</span>',
                    'Cumin + coriandre + gingembre'
                ],
                note:'üî™ Cuisson vapeur 20 min minimum',
                gastip:'üåø 500g l√©gumes = volume maximal digeste',
                cholesteroltip:'üíä D√Æner XXL l√©gumes = 500g = effet cholest√©rol maximal'
            },
            {
                id:'marche',
                nom:'Marche digestive',
                heure:'19:45',
                type:'activite',
                duree:'20-25 min',
                hydration:0.2,
                aliments:['200ml eau'],
                note:'‚ö†Ô∏è OBLIGATOIRE - Tous les soirs',
                gastip:'üåø Marche = syst√©matique pour digestion',
                cholesteroltip:'üíä Marche = +8-10% HDL (bon cholest√©rol)'
            },
            {
                id:'hydra_21h30',
                nom:'Hydratation',
                heure:'21:30',
                type:'hydratation',
                hydration:0.3,
                aliments:['300ml eau'],
                gastip:'üåø Pr√©-hydratation coucher'
            },
            {
                id:'avant_coucher',
                nom:'Avant coucher',
                heure:'22:00',
                calories:340,
                macros:{P:28,G:20,L:12},
                hydration:0.7,
                aliments:[
                    'Skyr 0% 250g',
                    'Fruits rouges 90g <span class="cholesterol-tag">‚≠ê ANTHOCYANES</span>',
                    'Cannelle 1/2 c. caf√© <span class="cholesterol-tag">‚≠ê INSULINE</span>',
                    'Graines chia 15g <span class="cholesterol-tag">‚≠ê OM√âGA-3</span>',
                    'Psyllium blond 5g <span class="cholesterol-tag">‚≠ê -18% LDL</span>',
                    '200ml eau + 500ml apr√®s psyllium',
                    'Tisane fenouil-gingembre'
                ],
                supplements:[
                    'Magn√©sium 500mg',
                    'Berb√©rine 500mg <span class="cholesterol-tag">‚≠ê DOSE 3/3</span>'
                ],
                note:'‚ö†Ô∏è Psyllium = attendre 30 min puis 500ml eau',
                gastip:'üåø Routine fixe optimale',
                cholesteroltip:'üíä Psyllium 5g = dose optimale -18% LDL'
            }
        ],
        hydrationTotal:4.3
    }
};

let semaineActuelle = 'S1';
let jourType = 'training';
let grignotages = [];
let pesees = JSON.parse(localStorage.getItem('pesees-hebdo') || '[]');
let derniereDateChargee = new Date().toISOString().split('T')[0];
let derniereSemaineChargee = 'S1';
let hydratationJour = 0;

window.onload = function() {
    updateSeasonDisplay();
    semaineActuelle = getSemaineActuelle();
    derniereSemaineChargee = semaineActuelle;
    derniereDateChargee = new Date().toISOString().split('T')[0];
    loadDayType();
    loadHydratation();
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    afficherSaison();
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    
    setInterval(verifierChangementDate, 60000);
    verifierEtNotifierChangementSemaine();
    verifierBackupHebdomadaire();
};

function verifierBackupHebdomadaire() {
    const lastBackup = localStorage.getItem('last-backup');
    const aujourdhui = new Date();
    const jourSemaine = aujourdhui.getDay();
    
    if (jourSemaine === 0) {
        if (!lastBackup) {
            rappelBackup('Tu n\'as jamais fait de backup ! üíæ');
        } else {
            const dateLastBackup = new Date(lastBackup);
            const diffJours = Math.floor((aujourdhui - dateLastBackup) / (1000 * 60 * 60 * 24));
            
            if (diffJours >= 7) {
                rappelBackup(`Dernier backup il y a ${diffJours} jours ! üìÖ`);
            }
        }
    }
}

function rappelBackup(message) {
    const lastNotif = localStorage.getItem('derniere-notif-backup');
    const today = new Date().toISOString().split('T')[0];
    
    if (lastNotif === today) return;
    
    setTimeout(() => {
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 4000; max-width: 400px; text-align: center; animation: modalPop 0.5s;';
        notification.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 15px;">üíæ</div>
            <h3 style="color: #667eea; margin-bottom: 10px;">Rappel Backup Hebdomadaire</h3>
            <p style="color: #666; margin-bottom: 20px;">${message}<br><small>Prot√®ge tes donn√©es avec un backup !</small></p>
            <button onclick="this.parentElement.remove(); document.querySelector('.tab[onclick*=export]').click(); setTimeout(() => telechargerBackup(), 500);" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 10px;">üíæ Faire backup</button>
            <button onclick="this.parentElement.remove();" style="background: #f0f0f0; color: #666; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer;">Plus tard</button>
        `;
        document.body.appendChild(notification);
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3999;';
        overlay.onclick = () => {
            notification.remove();
            overlay.remove();
        };
        document.body.appendChild(overlay);
        
        localStorage.setItem('derniere-notif-backup', today);
    }, 3000);
}

function verifierChangementDate() {
    const dateActuelle = new Date().toISOString().split('T')[0];
    const semaineActuelle_check = getSemaineActuelle();
    
    if (dateActuelle !== derniereDateChargee) {
        console.log('üîÑ Changement de date d√©tect√©:', derniereDateChargee, '‚Üí', dateActuelle);
        derniereDateChargee = dateActuelle;
        
        afficherMenu();
        loadGrignotages();
        loadHydratation();
        calculerProgression();
        
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 80px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 3000; font-weight: bold; animation: slideIn 0.5s;';
        notification.innerHTML = `üìÖ Nouveau jour d√©tect√© !<br><small style="opacity: 0.9; font-size: 12px;">Les donn√©es ont √©t√© mises √† jour</small>`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.5s';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }
    
    if (semaineActuelle_check !== derniereSemaineChargee) {
        console.log('üîÑ Changement de semaine d√©tect√©:', derniereSemaineChargee, '‚Üí', semaineActuelle_check);
        derniereSemaineChargee = semaineActuelle_check;
        semaineActuelle = semaineActuelle_check;
        
        afficherMenu();
        afficherCarteSemaine();
        updateTimelineVisuel();
        calculerProgression();
        
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 3000; font-weight: bold; text-align: center; animation: slideIn 0.5s; max-width: 90%;';
        notification.innerHTML = `üéâ NOUVELLE SEMAINE !<br><span style="font-size: 24px; margin: 10px 0; display: block;">${semaineActuelle_check}</span><small style="opacity: 0.9; font-size: 12px;">Pense √† faire ta pes√©e ce vendredi/samedi</small>`;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.5s';
            setTimeout(() => notification.remove(), 500);
        }, 5000);
    }
}

function verifierEtNotifierChangementSemaine() {
    const peseesSemaine = pesees.filter(p => p.semaine === semaineActuelle);
    const aujourdhui = new Date();
    const jourSemaine = aujourdhui.getDay();
    
    if ((jourSemaine === 5 || jourSemaine === 6) && peseesSemaine.length === 0) {
        const lastNotif = localStorage.getItem('derniere-notif-pesee');
        const today = new Date().toISOString().split('T')[0];
        
        if (lastNotif !== today) {
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 4000; max-width: 400px; text-align: center; animation: modalPop 0.5s;';
                notification.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">‚öñÔ∏è</div>
                    <h3 style="color: #667eea; margin-bottom: 10px;">Rappel Pes√©e Hebdomadaire</h3>
                    <p style="color: #666; margin-bottom: 20px;">C'est le moment id√©al pour te peser !<br><small>Vendredi/Samedi matin, √† jeun, apr√®s toilettes</small></p>
                    <button onclick="this.parentElement.remove(); ouvrirFormulairePesee();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 10px;">‚öñÔ∏è Faire ma pes√©e</button>
                    <button onclick="this.parentElement.remove();" style="background: #f0f0f0; color: #666; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer;">Plus tard</button>
                `;
                document.body.appendChild(notification);
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3999;';
                overlay.onclick = () => {
                    notification.remove();
                    overlay.remove();
                };
                document.body.appendChild(overlay);
                
                localStorage.setItem('derniere-notif-pesee', today);
            }, 2000);
        }
    }
}

function getSemaineActuelle() {
    const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
    const aujourdhui = new Date();
    const diffJours = Math.floor((aujourdhui - dateDebut) / (1000*60*60*24));
    const numSemaine = Math.floor(diffJours / 7) + 1;
    const semaine = 'S' + (numSemaine > 8 ? 8 : numSemaine < 1 ? 1 : numSemaine);
    return semaine;
}

function updateSeasonDisplay() {
    SAISON_ACTUELLE = getSaison();
    document.getElementById('season-badge').textContent = SAISON_ACTUELLE.emoji + ' ' + SAISON_ACTUELLE.nom.toUpperCase();
    document.getElementById('season-name-detail').textContent = SAISON_ACTUELLE.nom;
}

function afficherSaison() {
    const fruitsHTML = SAISON_ACTUELLE.fruits.map(f => `<span style="background: #fff9e6; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: bold;">üçé ${f}</span>`).join('');
    const legumesHTML = SAISON_ACTUELLE.legumes.map(l => `<span style="background: #e8f5e9; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: bold;">ü•¶ ${l}</span>`).join('');
    document.getElementById('fruits-saison').innerHTML = fruitsHTML;
    document.getElementById('legumes-saison').innerHTML = legumesHTML;
}

function setDayType(type) {
    jourType = type;
    localStorage.setItem('jourType', type);
    document.getElementById('day-display').textContent = type === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS';
    
    const menu = MENUS_BASE[type];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    
    document.getElementById('cal-total').textContent = config.calories[type];
    document.getElementById('prot-total').textContent = config.macros[type].P;
    document.getElementById('gluc-total').textContent = config.macros[type].G;
    document.getElementById('lip-total').textContent = config.macros[type].L;
    document.getElementById('hydra-total').textContent = menu.hydrationTotal.toFixed(1);
    
    afficherMenu();
    calculerProgression();
    showAutoSave();
}

function loadDayType() {
    const saved = localStorage.getItem('jourType');
    if (saved) jourType = saved;
    document.getElementById('day-display').textContent = jourType === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS';
}

function loadHydratation() {
    const today = new Date().toISOString().split('T')[0];
    const key = `hydra-${today}`;
    hydratationJour = parseFloat(localStorage.getItem(key) || '0');
}

function toggleHydratation(repasId, hydration) {
    const today = new Date().toISOString().split('T')[0];
    const key = `hydra-${today}`;
    const validations = JSON.parse(localStorage.getItem(`repas-${today}`) || '[]');
    
    if (validations.includes(repasId)) {
        hydratationJour += hydration;
    } else {
        hydratationJour -= hydration;
    }
    
    hydratationJour = Math.max(0, hydratationJour);
    localStorage.setItem(key, hydratationJour.toString());
    
    document.getElementById('hydra-actuel').textContent = hydratationJour.toFixed(1);
}

function afficherMenu() {
    const menu = MENUS_BASE[jourType];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    
    document.getElementById('semaine-actuelle-label').textContent = `${semaineActuelle} - ${config.nom.toUpperCase()}`;
    
    let html = '';
    menu.repas.forEach(repas => {
        const valide = isRepasValide(repas.id);
        
        if (repas.type === 'hydratation') {
            html += `<div class="nutrition-section">
                <h3>${repas.heure} - ${repas.nom}</h3>
                <div class="meal">
                    <div class="hydration-note">
                        <strong>üíß ${repas.hydration}L</strong><br>
                        ${repas.aliments.join('<br>')}
                    </div>
                    ${repas.gastip ? `<div class="gas-tip"><strong>üåø ASTUCE :</strong> ${repas.gastip}</div>` : ''}
                    <div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${repas.id}', ${repas.hydration || 0})">
                        <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
                        <span><strong>${valide ? '‚úÖ Fait' : '‚è∏Ô∏è √Ä faire'}</strong></span>
                    </div>
                </div>
            </div>`;
            return;
        }
        
        if (repas.type === 'activite') {
            html += `<div class="nutrition-section">
                <h3>${repas.heure} - ${repas.nom}</h3>
                <div class="meal">
                    <div style="background: #fff9e6; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                        <strong>‚è±Ô∏è ${repas.duree}</strong>
                    </div>
                    ${repas.hydration ? `<div class="hydration-note"><strong>üíß Hydratation :</strong> ${repas.hydration}L<br>${repas.aliments.join('<br>')}</div>` : ''}
                    ${repas.note ? `<div style="background: #ffebee; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 12px;"><strong>‚ö†Ô∏è</strong> ${repas.note}</div>` : ''}
                    ${repas.gastip ? `<div class="gas-tip"><strong>üåø ASTUCE :</strong> ${repas.gastip}</div>` : ''}
                    ${repas.cholesteroltip ? `<div style="background: #fff3bf; border-left: 4px solid #f59f00; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;"><strong>üíä CHOLEST√âROL :</strong> ${repas.cholesteroltip}</div>` : ''}
                    <div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${repas.id}', ${repas.hydration || 0})">
                        <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
                        <span><strong>${valide ? '‚úÖ Fait' : '‚è∏Ô∏è √Ä faire'}</strong></span>
                    </div>
                </div>
            </div>`;
            return;
        }
        
        html += `<div class="nutrition-section">
            <h3>${repas.heure} - ${repas.nom}</h3>
            <div class="meal">
                <div class="meal-details">
                    <div class="detail-item"><span class="detail-label">Cal:</span> ${repas.calories}</div>
                    <div class="detail-item"><span class="detail-label">P:</span> ${repas.macros.P}g</div>
                    <div class="detail-item"><span class="detail-label">G:</span> ${repas.macros.G}g</div>
                    <div class="detail-item"><span class="detail-label">L:</span> ${repas.macros.L}g</div>
                    ${repas.hydration ? `<div class="detail-item" style="background: #e3f2fd;"><span class="detail-label">üíß:</span> ${repas.hydration}L</div>` : ''}
                </div>
                <div class="meal-foods">
                    <strong>ü•ò Aliments:</strong>
                    <ul>${repas.aliments.map(a => `<li>${a}</li>`).join('')}</ul>
                </div>`;
        
        if (repas.supplements) {
            html += `<div class="meal-foods">
                <strong>üíä Suppl√©ments:</strong>
                <ul>${repas.supplements.map(s => `<li>${s}</li>`).join('')}</ul>
            </div>`;
        }
        
        if (repas.note) {
            html += `<div style="background: #fff9e6; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 12px;"><strong>‚ö†Ô∏è</strong> ${repas.note}</div>`;
        }
        
        if (repas.gastip) {
            html += `<div class="gas-tip"><strong>üåø ASTUCE :</strong> ${repas.gastip}</div>`;
        }
        
        if (repas.cholesteroltip) {
            html += `<div style="background: #fff3bf; border-left: 4px solid #f59f00; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;"><strong>üíä CHOLEST√âROL :</strong> ${repas.cholesteroltip}</div>`;
        }
        
        html += `<div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${repas.id}', ${repas.hydration || 0})">
            <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
            <span><strong>${valide ? '‚úÖ Valid√©' : '‚è∏Ô∏è √Ä valider'}</strong></span>
        </div>
        </div>
    </div>`;
    });
    
    document.getElementById('menu-container').innerHTML = html;
}

function toggleRepas(repasId, hydration) {
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    let validations = JSON.parse(localStorage.getItem(key) || '[]');
    const index = validations.indexOf(repasId);
    
    if (index > -1) {
        validations.splice(index, 1);
        if (hydration) {
            hydratationJour -= hydration;
        }
    } else {
        validations.push(repasId);
        if (hydration) {
            hydratationJour += hydration;
        }
    }
    
    hydratationJour = Math.max(0, hydratationJour);
    localStorage.setItem(key, JSON.stringify(validations));
    localStorage.setItem(`hydra-${today}`, hydratationJour.toString());
    
    afficherMenu();
    calculerProgression();
    showAutoSave();
}

function isRepasValide(repasId) {
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');
    return validations.includes(repasId);
}

function calculerProgression() {
    const menu = MENUS_BASE[jourType];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');
    
    let totalCal = 0, totalP = 0, totalG = 0, totalL = 0;
    validations.forEach(id => {
        const repas = menu.repas.find(r => r.id === id);
        if (repas && repas.calories) {
            totalCal += repas.calories;
            totalP += repas.macros.P;
            totalG += repas.macros.G;
            totalL += repas.macros.L;
        }
    });

    const grigJour = grignotages.filter(g => g.date === today);
    const totalGrig = grigJour.reduce((sum, g) => sum + g.calories, 0);
    totalCal += totalGrig;

    document.getElementById('cal-actuel').textContent = totalCal;
    document.getElementById('prot-actuel').textContent = totalP;
    document.getElementById('gluc-actuel').textContent = totalG;
    document.getElementById('lip-actuel').textContent = totalL;
    document.getElementById('hydra-actuel').textContent = hydratationJour.toFixed(1);

    const pct = Math.min(100, Math.round((totalCal / config.calories[jourType]) * 100));
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-bar').textContent = pct + '%';
}

function afficherSemaine(num) {
    semaineActuelle = 'S' + num;
    afficherMenu();
    calculerProgression();
    afficherCarteSemaine();
    updateTimelineVisuel();
    showAutoSave();
}

function updateTimelineVisuel() {
    const items = document.querySelectorAll('.timeline-item');
    const numActuel = parseInt(semaineActuelle.substring(1));
    
    items.forEach((item, i) => {
        const num = i + 1;
        item.classList.remove('active', 'completed', 'future');
        const pesee = pesees.find(p => p.semaine === 'S' + num);
        
        if (num < numActuel || pesee) {
            item.classList.add('completed');
        } else if (num === numActuel) {
            item.classList.add('active');
        } else {
            item.classList.add('future');
        }
    });

    const progress = ((numActuel - 1) / 7) * 90;
    document.getElementById('timeline-progress').style.width = progress + '%';
}

function afficherCarteSemaine() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const pesee = pesees.find(p => p.semaine === semaineActuelle);
    
    let html = `<div class="week-card ${config.phase}">
        <div class="week-header">
            <div class="week-title">${semaineActuelle} - ${config.nom}</div>
            <div class="phase-badge ${config.phase}">${config.phase.toUpperCase()}</div>
        </div>
        <div style="margin: 15px 0; color: #666; font-size: 14px;">
            <strong>üéØ Objectif :</strong> ${config.objectif}
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Calories Training</div>
                <div class="stat-value">${config.calories.training}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Calories Repos</div>
                <div class="stat-value">${config.calories.repos}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">D√©ficit cible</div>
                <div class="stat-value">${config.deficitCible}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Perte vis√©e</div>
                <div class="stat-value">${config.perteVisee}kg</div>
            </div>
        </div>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 15px;">
            <strong>üìä Macros Training :</strong> P${config.macros.training.P}g / G${config.macros.training.G}g / L${config.macros.training.L}g<br>
            <strong>üìä Macros Repos :</strong> P${config.macros.repos.P}g / G${config.macros.repos.G}g / L${config.macros.repos.L}g
        </div>`;
    
    if (pesee) {
        const deltaKg = pesee.deltaKg || 0;
        const deltaColor = deltaKg < 0 ? '#51cf66' : '#ff6b6b';
        html += `<div class="alert-box alert-success" style="margin-top: 15px;">
            <strong>‚úÖ Pes√©e enregistr√©e</strong><br>
            Poids: ${pesee.poids}kg (<span style="color: ${deltaColor}">${deltaKg > 0 ? '+' : ''}${deltaKg.toFixed(1)}kg</span>)<br>
            % Graisse: ${pesee.bf}% | Tour taille: ${pesee.taille}cm<br>
            √ânergie: ${pesee.energie}/10 | Digestion: ${pesee.digestion}/10 | Gaz: ${pesee.gaz}/10
        </div>`;
    } else {
        html += `<div class="alert-box alert-warning" style="margin-top: 15px;">
            <strong>‚ö†Ô∏è Pes√©e manquante</strong><br>
            Pense √† te peser ce vendredi ou samedi matin !
        </div>`;
    }
    
    html += `</div>`;
    document.getElementById('carte-semaine-actuelle').innerHTML = html;
}

function ouvrirFormulairePesee() {
    document.getElementById('input-semaine').value = semaineActuelle;
    document.getElementById('modal-pesee').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

function enregistrerPesee() {
    const semaine = document.getElementById('input-semaine').value;
    const poids = parseFloat(document.getElementById('input-poids').value);
    const bf = parseFloat(document.getElementById('input-bf').value);
    const taille = parseFloat(document.getElementById('input-taille').value) || null;
    const bras = parseFloat(document.getElementById('input-bras').value) || null;
    const energie = parseInt(document.getElementById('input-energie').value) || null;
    const digestion = parseInt(document.getElementById('input-digestion').value) || null;
    const gaz = parseInt(document.getElementById('input-gaz').value) || null;
    const notes = document.getElementById('input-notes-pesee').value;

    if (!poids || !bf) {
        alert('‚ö†Ô∏è Poids et % graisse obligatoires !');
        return;
    }

    const existingIndex = pesees.findIndex(p => p.semaine === semaine);
    const peseePrecedente = pesees.find(p => {
        const numSem = parseInt(semaine.substring(1));
        return p.semaine === 'S' + (numSem - 1);
    });

    const masseMaigre = poids * (1 - bf / 100);
    const masseGrasse = poids * (bf / 100);
    
    const pesee = {
        semaine,
        date: new Date().toISOString().split('T')[0],
        poids,
        bf,
        masseMaigre: parseFloat(masseMaigre.toFixed(1)),
        masseGrasse: parseFloat(masseGrasse.toFixed(1)),
        taille,
        bras,
        energie,
        digestion,
        gaz,
        notes,
        deltaKg: peseePrecedente ? parseFloat((poids - peseePrecedente.poids).toFixed(1)) : 0,
        deltaBF: peseePrecedente ? parseFloat((bf - peseePrecedente.bf).toFixed(1)) : 0,
        deltaTaille: peseePrecedente && taille && peseePrecedente.taille ? parseFloat((taille - peseePrecedente.taille).toFixed(1)) : null
    };

    if (existingIndex > -1) {
        pesees[existingIndex] = pesee;
    } else {
        pesees.push(pesee);
    }

    pesees.sort((a, b) => {
        const numA = parseInt(a.semaine.substring(1));
        const numB = parseInt(b.semaine.substring(1));
        return numA - numB;
    });

    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));

    document.getElementById('input-poids').value = '';
    document.getElementById('input-bf').value = '';
    document.getElementById('input-taille').value = '';
    document.getElementById('input-bras').value = '';
    document.getElementById('input-energie').value = '';
    document.getElementById('input-digestion').value = '';
    document.getElementById('input-gaz').value = '';
    document.getElementById('input-notes-pesee').value = '';

    closeModal('modal-pesee');
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    showAutoSave();
}

function afficherGraphiquePoids() {
    if (pesees.length === 0) {
        document.getElementById('svg-poids').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="14">Aucune donn√©e - Ajoute ta premi√®re pes√©e !</text>';
        return;
    }

    const svg = document.getElementById('svg-poids');
    const width = svg.clientWidth || 800;
    const height = 250;
    const padding = {top: 20, right: 50, bottom: 40, left: 50};
    
    const poidsData = [{semaine: 'S0', poids: PLAN_HYBRIDE.poidsInitial}, ...pesees];
    const minPoids = Math.min(...poidsData.map(p => p.poids)) - 1;
    const maxPoids = Math.max(...poidsData.map(p => p.poids)) + 1;
    
    const xScale = (width - padding.left - padding.right) / (poidsData.length - 1);
    const yScale = (height - padding.top - padding.bottom) / (maxPoids - minPoids);
    
    let pathD = '';
    let points = '';
    
    poidsData.forEach((p, i) => {
        const x = padding.left + i * xScale;
        const y = height - padding.bottom - ((p.poids - minPoids) * yScale);
        
        if (i === 0) pathD += `M ${x} ${y}`;
        else pathD += ` L ${x} ${y}`;
        
        const color = p.semaine === semaineActuelle ? '#667eea' : '#51cf66';
        points += `<circle cx="${x}" cy="${y}" r="5" fill="${color}" stroke="white" stroke-width="2"/>`;
        points += `<text x="${x}" y="${y - 10}" text-anchor="middle" font-size="11" font-weight="bold" fill="${color}">${p.poids}kg</text>`;
    });
    
    let gridLines = '';
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (height - padding.top - padding.bottom) * i / 4;
        const valeur = (maxPoids - (maxPoids - minPoids) * i / 4).toFixed(1);
        gridLines += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>`;
        gridLines += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${valeur}kg</text>`;
    }
    
    let xLabels = '';
    poidsData.forEach((p, i) => {
        const x = padding.left + i * xScale;
        xLabels += `<text x="${x}" y="${height - 10}" text-anchor="middle" font-size="11" fill="#666">${p.semaine}</text>`;
    });
    
    svg.innerHTML = `
        ${gridLines}
        <path d="${pathD}" fill="none" stroke="#667eea" stroke-width="3"/>
        ${points}
        ${xLabels}
        <text x="${width / 2}" y="15" text-anchor="middle" font-size="12" font-weight="bold" fill="#667eea">√âvolution du poids</text>
    `;
}

function afficherHistoriquePesees() {
    if (pesees.length === 0) {
        document.getElementById('historique-pesees').innerHTML = '<p style="color: #999; text-align: center;">Aucune pes√©e enregistr√©e</p>';
        return;
    }

    let html = '';
    pesees.slice().reverse().forEach(p => {
        const deltaColor = p.deltaKg < 0 ? '#51cf66' : p.deltaKg > 0 ? '#ff6b6b' : '#999';
        html += `<div class="progress-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <strong style="font-size: 18px; color: #667eea;">${p.semaine}</strong>
                    <span style="color: #999; margin-left: 10px; font-size: 12px;">${new Date(p.date).toLocaleDateString('fr-FR')}</span>
                </div>
                <button class="btn btn-danger" onclick="supprimerPesee('${p.semaine}')" style="padding: 6px 12px; font-size: 11px;">Supprimer</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Poids</div>
                    <div class="stat-value">${p.poids}kg</div>
                    ${p.deltaKg !== 0 ? `<div style="font-size: 11px; color: ${deltaColor}; font-weight: bold;">${p.deltaKg > 0 ? '+' : ''}${p.deltaKg}kg</div>` : ''}
                </div>
                <div class="stat-item">
                    <div class="stat-label">% Graisse</div>
                    <div class="stat-value">${p.bf}%</div>
                    ${p.deltaBF !== 0 ? `<div style="font-size: 11px; color: ${p.deltaBF < 0 ? '#51cf66' : '#ff6b6b'}; font-weight: bold;">${p.deltaBF > 0 ? '+' : ''}${p.deltaBF}%</div>` : ''}
                </div>
                ${p.taille ? `<div class="stat-item">
                    <div class="stat-label">Tour taille</div>
                    <div class="stat-value">${p.taille}cm</div>
                    ${p.deltaTaille ? `<div style="font-size: 11px; color: ${p.deltaTaille < 0 ? '#51cf66' : '#ff6b6b'}; font-weight: bold;">${p.deltaTaille > 0 ? '+' : ''}${p.deltaTaille}cm</div>` : ''}
                </div>` : ''}
                <div class="stat-item">
                    <div class="stat-label">Masse maigre</div>
                    <div class="stat-value">${p.masseMaigre}kg</div>
                </div>
            </div>
            ${p.energie || p.digestion || p.gaz ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                ${p.energie ? `‚ö° √ânergie: ${p.energie}/10 | ` : ''}
                ${p.digestion ? `üåø Digestion: ${p.digestion}/10 | ` : ''}
                ${p.gaz ? `üí® Gaz: ${p.gaz}/10` : ''}
            </div>` : ''}
            ${p.notes ? `<div style="background: #fff9e6; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                <strong>üìù Notes :</strong> ${p.notes}
            </div>` : ''}
        </div>`;
    });
    document.getElementById('historique-pesees').innerHTML = html;
}

function supprimerPesee(semaine) {
    if (!confirm(`Supprimer la pes√©e ${semaine} ?`)) return;
    pesees = pesees.filter(p => p.semaine !== semaine);
    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    showAutoSave();
}

function afficherAlertes() {
    if (pesees.length < 2) {
        document.getElementById('alertes-container').innerHTML = '';
        return;
    }

    const dernierePesee = pesees[pesees.length - 1];
    const config = PLAN_HYBRIDE.semaines[dernierePesee.semaine];
    const deltaKg = dernierePesee.deltaKg;
    const perteVisee = config.perteVisee;
    
    let html = '<div class="progress-card"><h3 style="color: #667eea; margin-bottom: 15px;">üö® Alertes & Recommandations</h3>';

    if (Math.abs(deltaKg - (-perteVisee)) > 0.5) {
        if (deltaKg > -0.3) {
            html += `<div class="alert-box alert-danger">
                <strong>üî¥ ALERTE : Perte trop lente</strong><br>
                Perte r√©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
                <strong>Actions :</strong><br>
                ‚Ä¢ R√©duire calories de 100-150 kcal/jour<br>
                ‚Ä¢ V√©rifier adh√©rence (repas valid√©s)<br>
                ‚Ä¢ Augmenter NEAT (marche 30 min/jour)
            </div>`;
        } else if (deltaKg < -1.5) {
            html += `<div class="alert-box alert-warning">
                <strong>üü† ATTENTION : Perte trop rapide</strong><br>
                Perte r√©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
                <strong>Actions :</strong><br>
                ‚Ä¢ Augmenter calories de 100-150 kcal/jour<br>
                ‚Ä¢ Ajouter glucides autour training<br>
                ‚Ä¢ Surveiller masse maigre (prot√©ines 2g/kg)
            </div>`;
        }
    } else {
        html += `<div class="alert-box alert-success">
            <strong>‚úÖ PROGRESSION OPTIMALE</strong><br>
            Perte r√©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
            Continue exactement comme √ßa ! üí™
        </div>`;
    }

    if (dernierePesee.gaz && dernierePesee.gaz > 5) {
        html += `<div class="alert-box alert-warning">
            <strong>üí® Gaz √©lev√©s (${dernierePesee.gaz}/10)</strong><br>
            ‚Ä¢ V√©rifier protocole anti-gaz (infusions, marche)<br>
            ‚Ä¢ Cuisson vapeur 20 min minimum<br>
            ‚Ä¢ √âviter aliments gazog√®nes
        </div>`;
    }

    if (dernierePesee.energie && dernierePesee.energie < 6) {
        html += `<div class="alert-box alert-warning">
            <strong>‚ö° √ânergie basse (${dernierePesee.energie}/10)</strong><br>
            ‚Ä¢ Augmenter glucides pr√©-training (+20g)<br>
            ‚Ä¢ Sommeil 8h minimum<br>
            ‚Ä¢ Envisager refeed si phase agressive
        </div>`;
    }

    const numSemaine = parseInt(dernierePesee.semaine.substring(1));
    if (numSemaine === 4) {
        html += `<div class="alert-box alert-info">
            <strong>ü©∫ SEMAINE 4 : Contr√¥le sanguin</strong><br>
            Penser √† refaire analyses :<br>
            ‚Ä¢ Bilan lipidique complet (cholest√©rol, LDL, HDL, triglyc√©rides)<br>
            ‚Ä¢ Glyc√©mie + HbA1c<br>
            ‚Ä¢ Vitamine D
        </div>`;
    }

    if (numSemaine === 8) {
        html += `<div class="alert-box alert-success">
            <strong>üéâ SEMAINE 8 : BILAN FINAL</strong><br>
            F√©licitations pour avoir termin√© le programme !<br>
            Penser √† faire le bilan sanguin final :<br>
            ‚Ä¢ Cholest√©rol total (objectif &lt;2g/L)<br>
            ‚Ä¢ LDL (objectif &lt;1.16g/L)<br>
            ‚Ä¢ HDL (objectif &gt;0.6g/L)<br>
            ‚Ä¢ Triglyc√©rides (objectif &lt;1g/L)
        </div>`;
    }

    html += '</div>';
    document.getElementById('alertes-container').innerHTML = html;
}

function openGrignotageModal() {
    document.getElementById('modal-grignotage').classList.add('show');
}

function ajouterGrignotage() {
    const aliment = document.getElementById('input-aliment').value.trim();
    const quantite = document.getElementById('input-quantite').value;
    const calories = document.getElementById('input-calories').value;
    
    if (!aliment || !quantite || !calories) {
        alert('‚ö†Ô∏è Remplis tous les champs');
        return;
    }

    const grig = {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
        aliment,
        quantite: parseInt(quantite),
        calories: parseInt(calories)
    };

    grignotages.push(grig);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));

    document.getElementById('input-aliment').value = '';
    document.getElementById('input-quantite').value = '';
    document.getElementById('input-calories').value = '';

    closeModal('modal-grignotage');
    loadGrignotages();
    calculerProgression();
    showAutoSave();
}

function loadGrignotages() {
    grignotages = JSON.parse(localStorage.getItem('grignotages') || '[]');
    const today = new Date().toISOString().split('T')[0];
    const grigJour = grignotages.filter(g => g.date === today);
    
    if (grigJour.length === 0) {
        document.getElementById('liste-grignotages').innerHTML = '<p style="color: #999; text-align: center;">Aucun grignotage aujourd\'hui üëç</p>';
        document.getElementById('total-grignotages').textContent = '+0 kcal';
        return;
    }

    let html = '';
    grigJour.forEach(g => {
        html += `<div class="grignotage-item"><div><strong>${g.heure} - ${g.aliment}</strong><br><small>${g.quantite}g ‚Ä¢ ${g.calories} kcal</small></div><button class="btn btn-danger" onclick="supprimerGrignotage(${g.id})">√ó</button></div>`;
    });
    document.getElementById('liste-grignotages').innerHTML = html;

    const total = grigJour.reduce((sum, g) => sum + g.calories, 0);
    const color = total > 500 ? '#ff6b6b' : total > 300 ? '#ffc107' : '#51cf66';
    document.getElementById('total-grignotages').innerHTML = `<span style="color: ${color}">+${total} kcal</span>`;
}

function supprimerGrignotage(id) {
    if (!confirm('Supprimer ce grignotage ?')) return;
    grignotages = grignotages.filter(g => g.id !== id);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    loadGrignotages();
    calculerProgression();
    showAutoSave();
}

function exportRapport() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const menu = MENUS_BASE[jourType];
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');
    const grigJour = grignotages.filter(g => g.date === today);
    
    let totalCal = 0, totalP = 0, totalG = 0, totalL = 0;
    validations.forEach(id => {
        const repas = menu.repas.find(r => r.id === id);
        if (repas && repas.calories) {
            totalCal += repas.calories;
            totalP += repas.macros.P;
            totalG += repas.macros.G;
            totalL += repas.macros.L;
        }
    });

    const totalGrig = grigJour.reduce((sum, g) => sum + g.calories, 0);
    totalCal += totalGrig;

    let rapport = `üî• RAPPORT PLAN ANTI-CHOLEST√âROL - ${today}\n`;
    rapport += `${semaineActuelle} - ${config.nom} (${config.phase.toUpperCase()})\n`;
    rapport += `${jourType === 'training' ? 'üèãÔ∏è JOUR TRAINING' : 'üí§ JOUR REPOS'}\n`;
    rapport += `${SAISON_ACTUELLE.emoji} Saison: ${SAISON_ACTUELLE.nom}\n\n`;
    
    rapport += `üéØ OBJECTIFS SEMAINE\n`;
    rapport += `Calories: ${config.calories[jourType]} kcal | D√©ficit: ${config.deficitCible} kcal\n`;
    rapport += `Perte vis√©e: -${config.perteVisee}kg\n`;
    rapport += `Macros: P${config.macros[jourType].P}g / G${config.macros[jourType].G}g / L${config.macros[jourType].L}g\n`;
    rapport += `Hydratation: ${menu.hydrationTotal}L\n\n`;
    
    rapport += `‚úÖ R√âALISATIONS JOUR\n`;
    rapport += `Calories: ${totalCal} kcal (${Math.round((totalCal / config.calories[jourType]) * 100)}%)\n`;
    rapport += `Prot√©ines: ${totalP}g | Glucides: ${totalG}g | Lipides: ${totalL}g\n`;
    rapport += `Hydratation: ${hydratationJour.toFixed(1)}L / ${menu.hydrationTotal}L (${Math.round((hydratationJour / menu.hydrationTotal) * 100)}%)\n`;
    rapport += `Repas valid√©s: ${validations.length}/${menu.repas.length}\n\n`;
    
    if (grigJour.length > 0) {
        rapport += `üç™ GRIGNOTAGES (+${totalGrig} kcal)\n`;
        grigJour.forEach(g => rapport += `${g.heure} - ${g.aliment} ${g.quantite}g (+${g.calories} kcal)\n`);
        rapport += `\n`;
    }

    rapport += `üíä PROTOCOLE ANTI-CHOLEST√âROL\n`;
    rapport += `‚úÖ Om√©ga-3 : 3 g√©lules\n`;
    rapport += `‚úÖ Berb√©rine : 500mg x2\n`;
    rapport += `‚úÖ Psyllium : 3g\n`;
    rapport += `‚úÖ Vitamine D3 : 10000 UI\n`;
    rapport += `‚úÖ Marche digestive : ${validations.includes('marche') ? 'OUI ‚úÖ' : 'NON ‚ùå'}\n\n`;

    rapport += `üìù NOTES\n${document.getElementById('notes-jour')?.value || '(Aucune note)'}\n\n`;
    
    rapport += `üìä PROGRESSION PROGRAMME\n`;
    rapport += `Semaine actuelle: ${semaineActuelle}/S8\n`;
    rapport += `Pes√©es enregistr√©es: ${pesees.length}/8\n`;
    if (pesees.length > 0) {
        const dernierePesee = pesees[pesees.length - 1];
        rapport += `Dernier poids: ${dernierePesee.poids}kg (${dernierePesee.bf}%)\n`;
        rapport += `√âvolution: ${dernierePesee.deltaKg > 0 ? '+' : ''}${dernierePesee.deltaKg}kg\n`;
    }

    navigator.clipboard.writeText(rapport).then(() => alert('‚úÖ Rapport copi√© !')).catch(() => alert('‚ùå Erreur copie'));
}

function exportRapportSemaine() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const pesee = pesees.find(p => p.semaine === semaineActuelle);
    
    let rapport = `üìä RAPPORT ${semaineActuelle} - ${config.nom}\n`;
    rapport += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    rapport += `üéØ OBJECTIFS\n`;
    rapport += `Phase: ${config.phase.toUpperCase()}\n`;
    rapport += `Objectif: ${config.objectif}\n`;
    rapport += `Calories Training: ${config.calories.training} kcal\n`;
    rapport += `Calories Repos: ${config.calories.repos} kcal\n`;
    rapport += `D√©ficit cible: ${config.deficitCible} kcal/jour\n`;
    rapport += `Perte vis√©e: -${config.perteVisee}kg\n\n`;
    
    if (pesee) {
        rapport += `‚öñÔ∏è R√âSULTATS\n`;
        rapport += `Poids: ${pesee.poids}kg (${pesee.deltaKg > 0 ? '+' : ''}${pesee.deltaKg}kg)\n`;
        rapport += `% Graisse: ${pesee.bf}% (${pesee.deltaBF > 0 ? '+' : ''}${pesee.deltaBF}%)\n`;
        rapport += `Masse maigre: ${pesee.masseMaigre}kg\n`;
        rapport += `Masse grasse: ${pesee.masseGrasse}kg\n`;
        if (pesee.taille) rapport += `Tour taille: ${pesee.taille}cm${pesee.deltaTaille ? ` (${pesee.deltaTaille > 0 ? '+' : ''}${pesee.deltaTaille}cm)` : ''}\n`;
        rapport += `\n`;
        
        const ecart = pesee.deltaKg - (-config.perteVisee);
        if (Math.abs(ecart) > 0.5) {
            rapport += `‚ö†Ô∏è ANALYSE\n`;
            if (ecart > 0.5) {
                rapport += `Perte insuffisante (${Math.abs(ecart).toFixed(1)}kg de moins que pr√©vu)\n`;
                rapport += `‚Üí R√©duire calories 100-150 kcal\n`;
                rapport += `‚Üí V√©rifier adh√©rence nutrition\n`;
            } else {
                rapport += `Perte excessive (${Math.abs(ecart).toFixed(1)}kg de plus que pr√©vu)\n`;
                rapport += `‚Üí Augmenter calories 100-150 kcal\n`;
                rapport += `‚Üí Surveiller masse maigre\n`;
            }
            rapport += `\n`;
        }
        
        if (pesee.energie || pesee.digestion || pesee.gaz) {
            rapport += `üîç INDICATEURS\n`;
            if (pesee.energie) rapport += `√ânergie: ${pesee.energie}/10\n`;
            if (pesee.digestion) rapport += `Digestion: ${pesee.digestion}/10\n`;
            if (pesee.gaz) rapport += `Gaz: ${pesee.gaz}/10\n`;
            rapport += `\n`;
        }
        
        if (pesee.notes) {
            rapport += `üìù NOTES\n${pesee.notes}\n\n`;
        }
    } else {
        rapport += `‚ö†Ô∏è PES√âE NON EFFECTU√âE\n`;
        rapport += `Penser √† se peser ce vendredi/samedi !\n\n`;
    }
    
    rapport += `üíä PROTOCOLE ANTI-CHOLEST√âROL\n`;
    rapport += `‚úÖ Om√©ga-3 3g/jour (baisse triglyc√©rides -25%)\n`;
    rapport += `‚úÖ Berb√©rine 500mg x2 (baisse LDL -25%)\n`;
    rapport += `‚úÖ Psyllium 3g/soir (baisse LDL -18%)\n`;
    rapport += `‚úÖ Vitamine D3 10000 UI\n`;
    rapport += `‚úÖ Aliments cl√©s : quinoa, noix, saumon, avocat\n`;
    rapport += `‚úÖ Marche apr√®s repas 15-20 min\n\n`;
    
    rapport += `üåø PROTOCOLE ANTI-GAZ\n`;
    rapport += `‚úÖ Infusions fenouil apr√®s repas\n`;
    rapport += `‚úÖ Cuisson vapeur 20 min minimum\n`;
    rapport += `‚úÖ √âpices carminatives (cumin, coriandre)\n`;
    rapport += `‚úÖ Marche digestive 20 min\n`;
    rapport += `‚úÖ Aliments de saison (${SAISON_ACTUELLE.nom})\n`;

    navigator.clipboard.writeText(rapport).then(() => alert('‚úÖ Rapport semaine copi√© !')).catch(() => alert('‚ùå Erreur copie'));
}

function resetJour() {
    if (!confirm('‚ö†Ô∏è R√©initialiser toutes les donn√©es d\'aujourd\'hui ?')) return;
    const today = new Date().toISOString().split('T')[0];
    localStorage.removeItem(`repas-${today}`);
    localStorage.removeItem(`hydra-${today}`);
    grignotages = grignotages.filter(g => g.date !== today);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    hydratationJour = 0;
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    alert('‚úÖ Journ√©e r√©initialis√©e');
}

function resetSemaine() {
    if (!confirm(`‚ö†Ô∏è Effacer TOUTES les donn√©es de ${semaineActuelle} ?\n\nCeci inclut :\n- Tous les repas valid√©s cette semaine\n- Les grignotages\n- La pes√©e\n- L'hydratation\n\nCette action est IRR√âVERSIBLE !`)) return;
    
    const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
    const numSemaine = parseInt(semaineActuelle.substring(1));
    const debutSemaine = new Date(dateDebut);
    debutSemaine.setDate(dateDebut.getDate() + ((numSemaine - 1) * 7));
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(debutSemaine);
        date.setDate(debutSemaine.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        localStorage.removeItem(`repas-${dateStr}`);
        localStorage.removeItem(`hydra-${dateStr}`);
    }
    
    grignotages = grignotages.filter(g => {
        const gDate = new Date(g.date);
        return gDate < debutSemaine || gDate >= new Date(debutSemaine.getTime() + 7 * 24 * 60 * 60 * 1000);
    });
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    
    pesees = pesees.filter(p => p.semaine !== semaineActuelle);
    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
    
    hydratationJour = 0;
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    updateTimelineVisuel();
    
    alert('‚úÖ Semaine r√©initialis√©e');
}

function resetTout() {
    if (!confirm('üóëÔ∏è ATTENTION : Effacer TOUTES les donn√©es ?\n\nCeci supprimera :\n- TOUS les repas valid√©s\n- TOUTES les pes√©es\n- TOUS les grignotages\n- Toute l\'hydratation\n- Toutes les notes\n\nCette action est D√âFINITIVE et IRR√âVERSIBLE !\n\n√ätes-vous S√õR ?')) return;
    
    if (!confirm('‚ö†Ô∏è DERNI√àRE CONFIRMATION\n\nVous allez perdre 100% de vos donn√©es.\n\nAvez-vous fait un backup ?\n\nContinuer ?')) return;
    
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-') || key.startsWith('hydra-') || key === 'grignotages' || key === 'pesees-hebdo' || key === 'jourType' || key === 'derniere-notif-pesee') {
            keysToRemove.push(key);
        }
    }
    
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    grignotages = [];
    pesees = [];
    semaineActuelle = 'S1';
    jourType = 'training';
    hydratationJour = 0;
    
    location.reload();
}

function telechargerBackup() {
    const backup = {
        version: '4.0-anticholesterol',
        dateExport: new Date().toISOString(),
        dateDebut: PLAN_HYBRIDE.dateDebut,
        poidsInitial: PLAN_HYBRIDE.poidsInitial,
        tailleInitiale: PLAN_HYBRIDE.tailleInitiale,
        semaineActuelle: semaineActuelle,
        jourType: jourType,
        repasValidations: {},
        hydratation: {},
        grignotages: grignotages,
        pesees: pesees
    };
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-')) {
            const date = key.replace('repas-', '');
            backup.repasValidations[date] = JSON.parse(localStorage.getItem(key));
        }
        if (key.startsWith('hydra-')) {
            const date = key.replace('hydra-', '');
            backup.hydratation[date] = parseFloat(localStorage.getItem(key));
        }
    }
    
    const nbJours = Object.keys(backup.repasValidations).length;
    const nbPesees = backup.pesees.length;
    const nbGrignotages = backup.grignotages.length;
    
    backup.stats = {
        nbJours,
        nbPesees,
        nbGrignotages
    };
    
    const jsonString = JSON.stringify(backup, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-anticholesterol-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('last-backup', new Date().toISOString());
    updateLastBackupDate();
    
    alert(`‚úÖ Backup t√©l√©charg√© !\n\nüìä Contenu :\n- ${nbJours} jours de donn√©es\n- ${nbPesees} pes√©es\n- ${nbGrignotages} grignotages\n\nüíæ Sauvegarde ce fichier en lieu s√ªr !`);
}

function restaurerBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!confirm('üì• Restaurer ce backup ?\n\n‚ö†Ô∏è Cela va REMPLACER toutes tes donn√©es actuelles !\n\nFais un backup de tes donn√©es actuelles avant de continuer.\n\nContinuer ?')) {
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (!backup.version || !backup.dateExport) {
                throw new Error('Fichier invalide');
            }
            
            PLAN_HYBRIDE.dateDebut = backup.dateDebut;
            PLAN_HYBRIDE.poidsInitial = backup.poidsInitial;
            PLAN_HYBRIDE.tailleInitiale = backup.tailleInitiale;
            
            Object.entries(backup.repasValidations).forEach(([date, validations]) => {
                localStorage.setItem(`repas-${date}`, JSON.stringify(validations));
            });
            
            if (backup.hydratation) {
                Object.entries(backup.hydratation).forEach(([date, hydra]) => {
                    localStorage.setItem(`hydra-${date}`, hydra.toString());
                });
            }
            
            grignotages = backup.grignotages || [];
            localStorage.setItem('grignotages', JSON.stringify(grignotages));
            
            pesees = backup.pesees || [];
            localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
            
            if (backup.jourType) {
                jourType = backup.jourType;
                localStorage.setItem('jourType', jourType);
            }
            
            alert(`‚úÖ Backup restaur√© !\n\nüìä Donn√©es import√©es :\n- ${backup.stats?.nbJours || 0} jours\n- ${backup.stats?.nbPesees || 0} pes√©es\n- ${backup.stats?.nbGrignotages || 0} grignotages\n\nL'application va se recharger.`);
            
            location.reload();
            
        } catch (error) {
            alert('‚ùå Erreur lors de la restauration !\n\nLe fichier est peut-√™tre corrompu ou invalide.\n\nErreur : ' + error.message);
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

function updateLastBackupDate() {
    const lastBackup = localStorage.getItem('last-backup');
    if (lastBackup) {
        const date = new Date(lastBackup);
        const formatted = date.toLocaleDateString('fr-FR') + ' √† ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('last-backup-date').textContent = formatted;
    }
}

window.addEventListener('load', updateLastBackupDate);

function showAutoSave() {
    const indicator = document.getElementById('auto-save-indicator');
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 2000);
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'suivi8sem') {
        afficherCarteSemaine();
        afficherGraphiquePoids();
        afficherHistoriquePesees();
        afficherAlertes();
    }
    if (tabName === 'saison') afficherSaison();
}
    </script>
</body>
</html>
